document.addEventListener("DOMContentLoaded", function() {
    const loginForm = document.getElementById("adminLoginForm");
    
    // Form submission
    loginForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        
        // Client-side validation
        if (!validateAdminEmail(email)) {
            showAlert("Invalid admin email format", "error");
            return;
        }
        
        authenticateAdmin(email, password);
    });
    
    // Password toggle
    window.togglePassword = function(id) {
        const input = document.getElementById(id);
        const icon = input.nextElementSibling.querySelector("i");
        if (input.type === "password") {
            input.type = "text";
            icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
            input.type = "password";
            icon.classList.replace("fa-eye-slash", "fa-eye");
        }
    }
});

// Validate admin email (must be from college domain)
function validateAdminEmail(email) {
    const collegeDomain = "yourcollege.edu"; // Set your college domain
    const regex = new RegExp(`^[A-Za-z0-9._%+-]+@${collegeDomain}$`, "i");
    return regex.test(email);
}

// Admin authentication
function authenticateAdmin(email, password) {
    showLoader(true);
    
    fetch("../api/admin-auth.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRF-Token": getCSRFToken()
        },
        body: JSON.stringify({
            email: email,
            password: password
        })
    })
    .then(response => {
        if (!response.ok) throw new Error("Authentication failed");
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Store admin session
            localStorage.setItem("adminToken", data.token);
            localStorage.setItem("adminPermissions", JSON.stringify(data.permissions));
            
            // Redirect to dashboard
            window.location.href = "dashboard.php";
        } else {
            showAlert(data.message || "Invalid credentials", "error");
        }
    })
    .catch(error => {
        console.error("Auth error:", error);
        showAlert("Security verification failed", "error");
    })
    .finally(() => showLoader(false));
}

// Security functions
function getCSRFToken() {
    // This would be generated by your server and embedded in the page
    return document.querySelector("meta[name='csrf-token']").content;
}

function showAlert(message, type) {
    // Reuse your existing alert system or create a new one
    const alertBox = document.createElement("div");
    alertBox.className = `admin-alert admin-alert-${type}`;
    alertBox.innerHTML = `
        <i class="fas fa-${type === "error" ? "exclamation-circle" : "check-circle"}"></i>
        ${message}
    `;
    document.body.appendChild(alertBox);
    setTimeout(() => alertBox.remove(), 5000);
}